<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Page metadata and responsiveness -->
  <meta charset="UTF-8" />
  <title>Time-Series Hate Crime Trends</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Load D3.js library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- External stylesheet -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Header and dropdown for region selection -->
  <div class="chart-background">
    <h1>📈 Hate Crimes Over Time</h1>
    <p>This dashboard shows time-series charts for hate crimes by province, motivation, and national totals.</p>

    <!-- Back to homepage and dropdown selector for region -->
    <div style="text-align: center;">
      <button onclick="window.location.href='index.html'" style="margin: 10px;">🏠 Back to Home</button>
      <label for="regionSelect" style="margin-left: 10px;">Select Province:</label>
      <select id="regionSelect" style="margin-left: 5px;"></select>
    </div>
  </div>

  <!-- Section for line chart showing trends by motivation in selected region -->
  <div class="chart-background">
    <h2>📍 Provincial Trends by Motivation</h2>
    <div id="lineChart" style="margin-bottom: 50px;"></div>
  </div>

  <!-- Section for national line chart comparison -->
  <div class="chart-background">
    <h2>📊 Canada-Wide Trends</h2>
    <div style="text-align: center; margin-bottom: 15px;">
      <label for="motivationSelect">Compare with Motivation:</label>
      <select id="motivationSelect"></select>
    </div>
  </div>

  <!-- Container for national chart -->
  <div class="chart-background">
    <div id="combinedChart" style="margin-top: 30px;"></div>
  </div>

  <!-- Tooltip for interactive chart elements -->
  <div id="line-tooltip" class="line-tooltip"></div>

  <!-- External script for loading and cleaning data -->
  <script src="script.js"></script>

  <script>
    // Select tooltip container
    const tooltip = d3.select("#line-tooltip");

    // Function to animate drawing lines
    function animateLine(svg, values, lineFunc, color) {
      const path = svg.append("path")
        .datum(values)
        .attr("fill", "none")
        .attr("stroke", color)
        .attr("stroke-width", 2)
        .attr("d", lineFunc);

      const totalLength = path.node().getTotalLength();

      path
        .attr("stroke-dasharray", `${totalLength} ${totalLength}`)
        .attr("stroke-dashoffset", totalLength)
        .transition()
        .duration(1500)
        .ease(d3.easeLinear)
        .attr("stroke-dashoffset", 0);
    }

    // Load clean data from script.js and initialize dropdowns and charts
    loadAndCleanData(data => {
      // Populate region dropdown
      const regions = Array.from(new Set(data.map(d => d.region))).sort();
      const regionSelect = d3.select("#regionSelect");

      regionSelect.selectAll("option")
        .data(regions)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

      regionSelect.on("change", () => {
        updateRegionChart(data, regionSelect.property("value"));
      });

      updateRegionChart(data, regions[0]);

      // Populate motivation dropdown
      const motivations = Array.from(new Set(data.map(d => d.motivation))).sort();
      const motivationSelect = d3.select("#motivationSelect");

      motivationSelect.selectAll("option")
        .data(motivations)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

      motivationSelect.on("change", () => {
        updateCombinedChart(data, motivationSelect.property("value"));
      });

      updateCombinedChart(data, motivations[0]);
    });

    // Function to draw regional line chart
    function updateRegionChart(data, selectedRegion) {
      const filtered = data.filter(d => d.region === selectedRegion);
      const nested = d3.groups(filtered, d => d.motivation);

      const margin = { top: 40, right: 120, bottom: 50, left: 60 };
      const width = 800 - margin.left - margin.right;
      const height = 400 - margin.top - margin.bottom;

      d3.select("#lineChart").html("");
      const svg = d3.select("#lineChart")
        .append("svg")
        .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
        .attr("preserveAspectRatio", "xMidYMid meet")
        .style("width", "100%")
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear()
        .domain(d3.extent(filtered, d => d.year))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(filtered, d => d.count)])
        .nice()
        .range([height, 0]);

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")));

      svg.append("g").call(d3.axisLeft(y));

      const color = d3.scaleOrdinal(d3.schemeSet2);

      nested.forEach(([motivation, values]) => {
        const sortedValues = values.sort((a, b) => a.year - b.year);
        const line = d3.line()
          .x(d => x(d.year))
          .y(d => y(d.count))
          .curve(d3.curveMonotoneX);

        animateLine(svg, sortedValues, line, color(motivation));

        // Draw circles and attach tooltip behavior
        svg.selectAll(null)
          .data(sortedValues)
          .enter()
          .append("circle")
          .attr("cx", d => x(d.year))
          .attr("cy", d => y(d.count))
          .attr("r", 4)
          .attr("fill", color(motivation))
          .on("mousemove", (event, d) => {
            tooltip
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY - 28) + "px")
              .style("opacity", 1)
              .html(`Year: ${d.year}<br>Count: ${d.count}<br>Motivation: ${d.motivation}`);
          })
          .on("mouseout", () => tooltip.style("opacity", 0))
          .on("mouseover", function () {
            d3.select(this).transition().duration(200).attr("r", 7);
          })
          .on("mouseout", function () {
            d3.select(this).transition().duration(200).attr("r", 4);
          });
      });
    }

    // Function to draw national comparison chart
    function updateCombinedChart(data, selectedMotivation) {
      const margin = { top: 40, right: 20, bottom: 50, left: 60 };
      const width = 800 - margin.left - margin.right;
      const height = 300 - margin.top - margin.bottom;

      const totalByYear = Array.from(
        d3.rollup(data, v => d3.sum(v, d => d.count), d => d.year),
        ([year, count]) => ({ year, count })
      ).sort((a, b) => a.year - b.year);

      const motivationByYear = Array.from(
        d3.rollup(data.filter(d => d.motivation === selectedMotivation), v => d3.sum(v, d => d.count), d => d.year),
        ([year, count]) => ({ year, count })
      ).sort((a, b) => a.year - b.year);

      d3.select("#combinedChart").html("");

      const svg = d3.select("#combinedChart")
        .append("svg")
        .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
        .attr("preserveAspectRatio", "xMidYMid meet")
        .style("width", "100%")
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear()
        .domain(d3.extent(totalByYear, d => d.year))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(totalByYear.concat(motivationByYear), d => d.count)])
        .nice()
        .range([height, 0]);

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")));

      svg.append("g").call(d3.axisLeft(y));

      const lineGen = d3.line()
        .x(d => x(d.year))
        .y(d => y(d.count))
        .curve(d3.curveMonotoneX);

      animateLine(svg, totalByYear, lineGen, "#e74c3c");
      animateLine(svg, motivationByYear, lineGen, "#3498db");

      // Draw tooltip-enabled circles for motivation line
      svg.selectAll(".motivation-circle")
        .data(motivationByYear)
        .enter()
        .append("circle")
        .attr("class", "motivation-circle")
        .attr("cx", d => x(d.year))
        .attr("cy", d => y(d.count))
        .attr("r", 4)
        .attr("fill", "#3498db")
        .on("mousemove", (event, d) => {
          const i = motivationByYear.indexOf(d);
          const prev = motivationByYear[i - 1];
          const change = prev ? (((d.count - prev.count) / prev.count) * 100).toFixed(1) : "-";
          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px")
            .style("opacity", 1)
            .html(`Year: ${d.year}<br>Count: ${d.count}<br>% Change: ${change === "-" ? "N/A" : change + "%"}`);
        })
        .on("mouseout", () => tooltip.style("opacity", 0))
        .on("mouseover", function () {
          d3.select(this).transition().duration(200).attr("r", 7);
        })
        .on("mouseout", function () {
          d3.select(this).transition().duration(200).attr("r", 4);
        });

      // Draw tooltip-enabled circles for total line
      svg.selectAll(".total-circle")
        .data(totalByYear)
        .enter()
        .append("circle")
        .attr("class", "total-circle")
        .attr("cx", d => x(d.year))
        .attr("cy", d => y(d.count))
        .attr("r", 4)
        .attr("fill", "#e74c3c")
        .on("mousemove", (event, d) => {
          const i = totalByYear.indexOf(d);
          const prev = totalByYear[i - 1];
          const change = prev ? (((d.count - prev.count) / prev.count) * 100).toFixed(1) : "-";
          tooltip
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px")
            .style("opacity", 1)
            .html(`Year: ${d.year}<br>Total Count: ${d.count}<br>% Change: ${change === "-" ? "N/A" : change + "%"}`);
        })
        .on("mouseout", () => tooltip.style("opacity", 0))
        .on("mouseover", function () {
          d3.select(this).transition().duration(200).attr("r", 7);
        })
        .on("mouseout", function () {
          d3.select(this).transition().duration(200).attr("r", 4);
        });
    }
  </script>
   <details id="mapInfoDetails">
    <summary><strong>What is a hate crime and why does it matter?</strong></summary>
    <p>
      A hate crime is a criminal act motivated by bias or prejudice against a person or group based on race, ethnicity, religion, sexual orientation, gender identity, or other protected characteristics. These crimes not only harm individuals but also spread fear and trauma throughout entire communities.
    </p>
  
    <p>
      In Canada, hate crimes are rising. According to 
      <a href="https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3510019101&cubeTimeFrame.startYear=2014&cubeTimeFrame.endYear=2023&referencePeriods=20140101%2C20230101" target="_blank">
        Statistics Canada
      </a>, police-reported hate crimes increased from 
      <strong>1,295 in 2014 to 4,777 in 2023</strong> — an increase of over <strong>269%</strong>. This dashboard was developed to help visualize this alarming trend across Canadian provinces and explore the motivations behind these incidents.
    </p>
    <p>
      If you are a victim or witness of a hate crime, it is important to report the incident to local police. Support is also available through provincial and municipal services, including trauma counseling, legal support, and anti-violence advocacy organizations.
    </p>
  </details>
  
  <!-- Footer with student name -->
  <footer class="custom-footer">
    Ayşegül Dahi | Student ID: 300387536
  </footer>

</body>
</html>
